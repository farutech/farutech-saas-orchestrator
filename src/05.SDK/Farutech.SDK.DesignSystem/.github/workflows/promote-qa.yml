# .github/workflows/promote-qa.yml
name: Promote to QA

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to promote (e.g., 2026.01.31.0-alpha.3)'
        required: true
      reason:
        description: 'Reason for promotion'
        required: false
        default: 'QA testing'

jobs:
  promote-qa:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
      pull-requests: write
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: dev
          fetch-depth: 0
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18.x'
          registry-url: 'https://npm.pkg.github.com'
      
      - name: Validate Version
        run: |
          if [[ ! "${{ github.event.inputs.version }}" =~ ^[0-9]{4}\.[0-9]{2}\.[0-9]{2}\.[0-9]+(-alpha\.[0-9]+)?$ ]]; then
            echo "‚ùå Invalid version format"
            exit 1
          fi
      
      - name: Checkout QA Branch
        run: |
          git checkout qa || git checkout -b qa
          git merge dev --no-ff -m "Promote ${{ github.event.inputs.version }} to QA"
      
      - name: Install & Build
        run: |
          npm ci
          npm run build
      
      - name: Update to Beta Version
        run: npm run version:beta
      
      - name: Publish to GitHub Packages (QA Tag)
        run: npm publish --tag qa
        env:
          NODE_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Create Pull Request to Staging
        run: |
          gh pr create \
            --base staging \
            --head qa \
            --title "Promote ${{ github.event.inputs.version }} to Staging" \
            --body "Automated promotion from QA to Staging"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}